From 0f4be8919707fd8bbb0005667f0705f4169696d3 Mon Sep 17 00:00:00 2001
From: Simon McVittie <smcv@debian.org>
Date: Sat, 3 Jan 2009 12:04:48 +0000
Subject: [PATCH] Add new #defines to indicate which syscall is umount(3) and which is umount2(3).

* on architectures where __NR_umount is umount(3) and __NR_umount2 is
  umount2(3), don't do anything special
* on architectures where this is not the case, define __NR_umount_with_flags
  so that it's umount2(3)
* define __NR_umount_without_flags to be umount(3) on architectures where
  such a syscall exists

In the currently-supported architectures there are four families:

* on i386, arm etc., __NR_umount takes one argument and __NR_umount2 takes two
* on x86_64 and parisc __NR_umount2 takes two arguments and there is no
  1-argument umount
* on alpha, __NR_oldumount takes one argument and __NR_umount takes two
* on ia64, __NR_umount takes two arguments and there is no 1-argument umount
---
 alpha/syscalls.h     |    2 ++
 ia64/syscalls.h      |    1 +
 syscalls.s/umount.S  |    4 ++++
 syscalls.s/umount2.S |    4 +++-
 4 files changed, 10 insertions(+), 1 deletions(-)

diff --git a/alpha/syscalls.h b/alpha/syscalls.h
index c40a81c..7a78209 100644
--- a/alpha/syscalls.h
+++ b/alpha/syscalls.h
@@ -381,6 +381,8 @@
 #define __NR_inotify_add_watch		445
 #define __NR_inotify_rm_watch		446
 
+#define __NR_umount_without_flags __NR_oldumount
+#define __NR_umount_with_flags __NR_umount
 
 #define syscall_weak(name,wsym,sym) \
 .text ; \
diff --git a/ia64/syscalls.h b/ia64/syscalls.h
index 515242c..e41433a 100644
--- a/ia64/syscalls.h
+++ b/ia64/syscalls.h
@@ -280,6 +280,7 @@
 #define __NR_tee			1301
 #define __NR_vmsplice			1302
 
+#define __NR_umount_with_flags __NR_umount
 
 #define syscall(name, sym) \
 .text; \
diff --git a/syscalls.s/umount.S b/syscalls.s/umount.S
index 4a423d9..89793e2 100644
--- a/syscalls.s/umount.S
+++ b/syscalls.s/umount.S
@@ -1,3 +1,7 @@
 #include "syscalls.h"
 
+#if defined(__NR_umount_without_flags)
+syscall(umount_without_flags,umount)
+#elif !defined(__NR_umount_with_flags) || (__NR_umount != __NR_umount_with_flags)
 syscall(umount,umount)
+#endif
diff --git a/syscalls.s/umount2.S b/syscalls.s/umount2.S
index b27b353..5742416 100644
--- a/syscalls.s/umount2.S
+++ b/syscalls.s/umount2.S
@@ -1,5 +1,7 @@
 #include "syscalls.h"
 
-#ifdef __NR_umount2
+#if defined(__NR_umount_with_flags)
+syscall(umount_with_flags,umount2)
+#elif defined(__NR_umount2)
 syscall(umount2,umount2)
 #endif
-- 
1.5.6.5

